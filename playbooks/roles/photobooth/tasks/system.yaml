- name: Upgrade system packages
  become: true
  ansible.builtin.apt:
    update_cache: true
    autoclean: true
    autoremove: true
    upgrade: full

- name: Disable Wifi and remove wifi-powersave-off service if WiFi is disabled
  when: disable_wifi | default(false)
  block:
    # we disable wifi on photoboothes, if flagged, because they might have a dedicated router and additional wifi leads to
    # unpredicted behaviour which route is taken
    - name: Ensure dtoverlay=disable-wifi is present when requested
      become: true
      ansible.builtin.lineinfile:
        path: /boot/firmware/config.txt
        regexp: "^dtoverlay=disable-wifi"
        line: "dtoverlay=disable-wifi"
        insertafter: EOF

- name: Ensure wifi-powersave-off service exists and is active when WiFi is enabled
  when: not (disable_wifi | default(false))
  block:
    - name: Create systemd service to disable WiFi power save
      become: true
      ansible.builtin.copy:
        dest: /etc/systemd/system/wifi-powersave-off.service
        mode: '0644'
        content: |
          [Unit]
          Description=Disable WiFi power save mode
          After=network.target

          [Service]
          Type=oneshot
          ExecStart=iw dev wlan0 set power_save off
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd daemon
      become: true
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable and start wifi-powersave-off service
      become: true
      check_mode: false
      ansible.builtin.systemd:
        name: wifi-powersave-off.service
        enabled: true
        state: started


- name: Disable all automatic services (useless if write protected)
  become: true
  block:
    - name: Disable apt-daily services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: false
        state: stopped
        masked: true
      loop:
        - apt-daily.service
        - apt-daily.timer
        - apt-daily-upgrade.service
        - apt-daily-upgrade.timer

    - name: Remove unattended-upgrades package
      ansible.builtin.apt:
        name: unattended-upgrades
        state: absent

    - name: Ensure journald is volatile (no persistent logs)
      ansible.builtin.lineinfile:
        path: /etc/systemd/journald.conf
        regexp: '^Storage='
        line: 'Storage=volatile'
        create: false
